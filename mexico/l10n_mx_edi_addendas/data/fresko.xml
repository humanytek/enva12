<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--This is the addenda-->
    <template id="fresko" name="Fresko">
        <t t-set="values" t-value="record._l10n_mx_edi_create_cfdi_values()"/>
        <t t-set="extra_values" t-value="record.x_addenda_fresko.split('|') if record.x_addenda_fresko else ['', '', '', '', '']"/>
        <requestForPayment
            type="SimpleInvoiceType"
            contentVersion="1.3.1"
            documentStructureVersion="AMC7.1"
            documentStatus="ORIGINAL"
            t-att-DeliveryDate="record.date_invoice">
            <requestForPaymentIdentification>
                <entityType t-raw="'INVOICE' if record.type == 'out_invoice' else 'CREDIT_NOTE'"/>
                <uniqueCreatorIdentification t-raw="record.number"/>
            </requestForPaymentIdentification>
            <specialInstruction code="AAB" t-if="record.payment_term_id">
                <text t-raw="record.payment_term_id.name"/>
            </specialInstruction>
            <specialInstruction code="ZZZ">
                <text t-raw="record.l10n_mx_edi_amount_to_text()"/>
            </specialInstruction>
            <orderIdentification>
                <referenceIdentification type="ON" t-raw="record.origin"/>
                <ReferenceDate t-raw="extra_values[3]"/>
            </orderIdentification>
            <AdditionalInformation>
                <referenceIdentification type="DQ" t-raw="extra_values[4]"/>
            </AdditionalInformation>
            <DeliveryNote>
                <referenceIdentification t-raw="extra_values[2]"/>
                <referenceDate t-raw="extra_values[1]"/>
            </DeliveryNote>
            <buyer>
                <gln>7505000099632</gln>
                <contactInformation>
                    <personOrDepartmentName>
                        <text>0</text>
                    </personOrDepartmentName>
                </contactInformation>
            </buyer>
            <seller>
                <gln>0000000026153</gln>
                <alternatePartyIdentification type="SELLER_ASSIGNED_IDENTIFIER_FOR_A_PARTY">26153</alternatePartyIdentification>
            </seller>
            <shipTo><gln t-raw="extra_values[0] if extra_values[0] else '7505000352805'"/></shipTo>
            <InvoiceCreator>
                <gln>0000000026153</gln>
                <alternatePartyIdentification type="IA">26153</alternatePartyIdentification>
            </InvoiceCreator>
            <currency t-att-currencyISOCode="record.currency_id.name">
                <currencyFunction>BILLING_CURRENCY</currencyFunction>
                <rateOfChange t-raw="values['rate'] if record.currency_id.name != 'MXN' else 1"/>
            </currency>
            <paymentTerms paymentTermsEvent="DATE_OF_INVOICE" PaymentTermsRelationTime="REFERENCE_AFTER">
                <netPayment netPaymentTermsType="BASIC_NET">
                    <paymentTimePeriod>
                        <timePeriodDue timePeriod="DAYS">
                            <value t-raw="(record.date_due - record.date_invoice).days"/>
                        </timePeriodDue>
                    </paymentTimePeriod>
                </netPayment>
                <discountPayment discountType="ALLOWANCE_BY_PAYMENT_ON_TIME">
                    <percentage>0.000</percentage>
                </discountPayment>
            </paymentTerms>
            <allowanceCharge settlementType="BILL_BACK" allowanceChargeType="ALLOWANCE_GLOBAL">
                <specialServicesType>AJ</specialServicesType>
                <monetaryAmountOrPercentage><rate base="INVOICE_VALUE">
                        <percentage>0.00</percentage>
                    </rate>
                </monetaryAmountOrPercentage>
            </allowanceCharge>
            <t t-foreach="record.invoice_line_ids" t-as="line">
                <lineItem type="SimpleInvoiceLineItemType"
                    t-att-number="line_index + 1">
                    <tradeItemIdentification>
                        <gtin t-raw="record._get_string_cfdi(line.product_id.default_code or '')"/>
                    </tradeItemIdentification>
                    <alternateTradeItemIdentification type="BUYER_ASSIGNED" t-raw="record._get_string_cfdi(line.product_id.default_code or '')"/>
                    <tradeItemDescriptionInformation>
                        <longText t-raw="record._get_string_cfdi(line.name, 1000)"/>
                    </tradeItemDescriptionInformation>
                    <invoicedQuantity
                        t-esc-unitOfMeasure="line.uom_id.l10n_mx_edi_code_sat_id.code" t-raw="line.quantity"/>
                    <grossPrice>
                        <Amount t-raw="values.get('subtotal_wo_discount')(line)/line.quantity"/>
                    </grossPrice>
                    <netPrice>
                        <Amount t-raw="values.get('subtotal_wo_discount')(line)/line.quantity"/>
                    </netPrice>
                    <AdditionalInformation>
                        <referenceIdentification type="ON" t-raw="record._get_string_cfdi(line.product_id.default_code or '')"/>
                    </AdditionalInformation>
                    <totalLineAmount>
                        <grossAmount>
                            <Amount t-raw="values.get('subtotal_wo_discount')(line)"/>
                        </grossAmount>
                        <netAmount>
                            <Amount t-raw="values.get('subtotal_wo_discount')(line)"/>
                        </netAmount>
                    </totalLineAmount>
                </lineItem>
            </t>
            <totalAmount>
                <Amount t-raw="values['amount_total']"/>
            </totalAmount>
            <TotalAllowanceCharge allowanceOrChargeType="ALLOWANCE">
                <Amount>0.00</Amount>
            </TotalAllowanceCharge>
            <baseAmount>
                <Amount t-raw="values['amount_untaxed']"/>
            </baseAmount>
            <payableAmount>
                <Amount t-raw="values['amount_total']"/>
            </payableAmount>
        </requestForPayment>
    </template>
    <record id="fresko" model="ir.ui.view">
        <field name="l10n_mx_edi_addenda_flag">True</field>
    </record>
    <!--Wizard to set elements-->
    <record id="wizard_fresko" model="ir.model">
        <field name="name">Addenda Fresko</field>
        <field name="transient" eval="True"/>
        <field name="model">x_addenda.fresko</field>
        <field name="info">Addenda Fresko documentation</field>
    </record>

    <!--Fields on the wizard-->
    <record id="wizard_fresko_reception" model="ir.model.fields">
        <field name="name">x_reception</field>
        <field name="field_description">GLN Reception Number</field>
        <field name="ttype">char</field>
        <field name="required">0</field>
        <field name="help">The code given to the product when it arrives at stock location. This code is provided by the supplier.
            Leave empty if you want to keep the default GLN reception number (7505000352805)</field>
        <field name="model_id" ref="wizard_fresko"/>
    </record>
    <record id="wizard_fresko_reception_date" model="ir.model.fields">
        <field name="name">x_reception_date</field>
        <field name="field_description">Reception Date</field>
        <field name="ttype">date</field>
        <field name="required">1</field>
        <field name="help">The date when was received the products.</field>
        <field name="model_id" ref="wizard_fresko"/>
    </record>
    <record id="wizard_fresko_reception_number" model="ir.model.fields">
        <field name="name">x_reception_number</field>
        <field name="field_description">Folio Number</field>
        <field name="ttype">char</field>
        <field name="required">1</field>
        <field name="help">The reception number in the customer system.</field>
        <field name="model_id" ref="wizard_fresko"/>
    </record>
    <record id="wizard_fresko_po_date" model="ir.model.fields">
        <field name="name">x_po_date</field>
        <field name="field_description">Date Purchase Order</field>
        <field name="ttype">date</field>
        <field name="required">1</field>
        <field name="help">The date of the purchase order.</field>
        <field name="model_id" ref="wizard_fresko"/>
    </record>
    <record id="wizard_fresko_reception_folio" model="ir.model.fields">
        <field name="name">x_additional_reference</field>
        <field name="field_description">Additional Reference</field>
        <field name="ttype">char</field>
        <field name="required">1</field>
        <field name="help">Aditional Reference Number</field>
        <field name="model_id" ref="wizard_fresko"/>
    </record>

    <!--Fields in invoice-->
    <record id="invoice_fresko_field" model="ir.model.fields">
        <field name="name">x_addenda_fresko</field>
        <field name="field_description">Addenda Fresko</field>
        <field name="ttype">char</field>
        <field name="help">Used to concatenate wizard fields</field>
        <field name="model_id" model="ir.model" search="[('model', '=', 'account.invoice')]"/>
    </record>

    <!--Server action that will set the values on the invoice.-->
    <record id="set_addenda_fresko_values" model="ir.actions.server">
        <field name="name">Set Values Addenda Fresko</field>
        <field name="model_id" ref="account.model_account_invoice"/>
        <field name="state">code</field>
        <field name="code">
invoice = env['account.invoice'].browse(model._context['invoice_id'])
wizard = env['x_addenda.fresko'].browse(model._context['active_id'])
wizard_values = [
    wizard.x_reception, wizard.x_reception_date.strftime('%Y-%m-%d'),
    wizard.x_reception_number, wizard.x_po_date.strftime('%Y-%m-%d'),
    wizard.x_additional_reference.zfill(13),
]
wizard_values = '|'.join([value or '' for value in wizard_values])
invoice.write({'x_addenda_fresko': wizard_values})
        </field>
    </record>

    <!--
    View of the wizard itself that set the values this view need to hold all
    the help information necessary if needed
    -->
    <record id="wizard_fresko_view" model="ir.ui.view">
        <field name="name">x_addenda.fresko.view</field>
        <field name="model">x_addenda.fresko</field>
        <field name="arch" type="xml">
            <form>
                <div>
                    <p>
                        The necessary nodes for the implementation of the Addenda of Fresko City
                    </p>
                </div>
                <group>
                    <group>
                        <field name="x_reception"/>
                        <field name="x_reception_date"/>
                        <field name="x_reception_number"/>
                    </group>
                    <group>
                        <field name="x_po_date"/>
                        <field name="x_additional_reference"/>
                    </group>
                </group>
                <footer>
                    <button name="l10n_mx_edi_addendas.set_addenda_fresko_values"
                    type="action" string="Set Values" class="btn-primary"/>
                    <button string="Cancel" class="btn-default" special="cancel" />
                </footer>
            </form>
        </field>
    </record>

    <!--
    Simple action view that is called from the invoice to open the wizard
    After default values are set.
    -->
    <record id="action_addenda_fresko" model="ir.actions.act_window">
        <field name="name">Addenda Fresko</field>
        <field name="res_model">x_addenda.fresko</field>
        <field name="target">new</field>
        <field name="view_id" ref="wizard_fresko_view"/>
    </record>

    <!--
    Action to set default values on the wizard
    -->
    <record id="action_addenda_fresko_defaults" model="ir.actions.server">
        <field name="name">Set default values for the addenda Fresko</field>
        <field name="model_id" ref="account.model_account_invoice"/>
        <field name="state">code</field>
        <field name="code">
context = {'invoice_id': record.id}
wizard_values = record.x_addenda_fresko and record.x_addenda_fresko.split('|')
# If the wizard has been run before, fill it with its previows values
if wizard_values:
    context.update({
        'default_x_reception': wizard_values[0],
        'default_x_reception_date': wizard_values[1],
        'default_x_reception_number': wizard_values[2],
        'default_x_po_date': wizard_values[3],
        'default_x_additional_reference': wizard_values[4],
    })
action = env.ref('l10n_mx_edi_addendas.action_addenda_fresko').read()[0]
action['context'] = context
        </field>
    </record>

    <!--
    Put a button on the invoice itself in order to set the value for the addenda
    -->
    <record id="invoice_addenda_fresko" model="ir.ui.view">
        <field name="name">account.invoice.form.fresko</field>
        <field name="model">account.invoice</field>
        <field name="inherit_id" ref="account.invoice_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="before">
                <button name="l10n_mx_edi_addendas.action_addenda_fresko_defaults" type="action"
                        string="Addenda Fresko"
                        context="{'invoice_id': id}"
                        attrs="{'invisible': [('state', 'not in', ['draft'])]}"
                        />
            </xpath>
            <!-- Don't hide the origin field so it may be always editable -->
            <xpath expr="//page[@name='other_info']//field[@name='origin']" position="attributes">
                <attribute name="attrs"/>
            </xpath>
        </field>
    </record>
</odoo>
